<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MatchMaster | Sube de Nivel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        html, body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            overflow-x: hidden;
            overscroll-behavior-x: none;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        .signature-font { font-family: 'Dancing Script', cursive; }
        .aura-purple {
            position: absolute; top: -10%; left: -10%; width: 600px; height: 600px;
            background: rgba(147, 51, 234, 0.3); border-radius: 50%; filter: blur(140px);
            animation: float-aura 7s infinite alternate ease-in-out; z-index: 0;
        }
        .aura-blue {
            position: absolute; bottom: -10%; right: -10%; width: 600px; height: 600px;
            background: rgba(59, 130, 246, 0.3); border-radius: 50%; filter: blur(140px);
            animation: float-aura 9s infinite alternate-reverse ease-in-out; z-index: 0;
        }
        @keyframes float-aura {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(60px, 60px) scale(1.1); }
        }
        .floating-card { animation: float-card 4s ease-in-out infinite; }
        @keyframes float-card {
            0%, 100% { transform: translateY(0px) rotate(-1deg); }
            50% { transform: translateY(-12px) rotate(1deg); }
        }
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #a855f7, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-size: 200% auto; animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        .btn-loading {
            pointer-events: none; opacity: 0.8;
            background: linear-gradient(to right, #4b5563, #6b7280) !important;
            box-shadow: none !important;
        }
        .glass-sidebar {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    </style>
</head>
<body class="text-white min-h-screen relative flex items-center justify-center p-4 md:p-8">

    <div id="userProfileHeader" class="fixed top-4 right-4 z-40 hidden bg-white/10 backdrop-blur-md border border-white/20 rounded-full px-4 py-2 flex items-center gap-3 shadow-xl transition-all">
        <img id="userProfilePic" src="" alt="Perfil" class="w-8 h-8 rounded-full border border-white/50 object-cover">
        <span id="userProfileName" class="text-sm font-bold text-white hidden md:inline"></span>
        <button onclick="logoutGoogle()" class="text-[11px] text-red-400 hover:text-red-300 font-black ml-2 uppercase tracking-wider bg-white/5 px-2 py-1 rounded-lg">Salir</button>
    </div>

    <div class="aura-purple"></div>
    <div class="aura-blue"></div>

    <div class="relative z-10 w-full max-w-6xl mx-auto flex flex-col md:flex-row gap-8 items-start justify-center pt-10 md:pt-0">

        <main class="flex-1 flex flex-col items-center md:items-start text-center md:text-left max-w-2xl" id="mainSection">
            
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 backdrop-blur-md border border-white/10 text-sm font-bold text-blue-100 mb-8 shadow-xl">
                <span class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                BETA PRIVADA
            </div>

            <h1 id="mainTitle" class="text-5xl md:text-7xl font-black tracking-tight leading-tight mb-2">
                Sube de nivel.<br>
                Usa <span class="text-gradient">MatchMaster.</span>
            </h1>
            <p id="mainSubtitle" class="signature-font text-2xl text-slate-300 mb-6 ml-2 transform -rotate-2">by Belliard</p>

            <p id="mainDescription" class="text-slate-300 text-lg md:text-xl max-w-xl mb-12 font-medium leading-relaxed">
                La red exclusiva para conectar con Masters y t√©cnicos, compartir conocimientos y agendar citas con t√©cnicos profesionales para solucionar trabajos del hogar. üöÄ
            </p>

            <div id="matchCard" class="w-full max-w-sm bg-white/10 backdrop-blur-xl border border-white/20 rounded-[2rem] p-6 shadow-2xl floating-card text-left transition-all duration-300 hover:scale-105 mx-auto md:mx-0 opacity-50">
                
                <div id="cardContent">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div id="mainAvatar" class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center text-xl font-black shadow-lg text-white">
                                ‚è≥
                            </div>
                            <div>
                                <h3 id="mainName" class="font-bold text-xl leading-none text-white">Cargando Master...</h3>
                                <p class="text-xs text-blue-100 font-semibold mt-1">Conectando a la base de datos</p>
                            </div>
                        </div>
                        <div id="mainStatus" class="bg-blue-500/30 text-blue-100 text-xs font-black px-3 py-1.5 rounded-full border border-blue-500/50 flex items-center gap-1">
                            ...
                        </div>
                    </div>
                    
                    <div class="space-y-4 mb-8">
                        <div>
                            <span class="text-[11px] text-slate-200 uppercase font-black tracking-widest">Tengo mucho conocimiento de:</span>
                            <div id="mainMasters" class="flex flex-wrap gap-2 mt-2">
                            </div>
                        </div>
                    </div>

                    <button id="connectBtn" class="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 font-black text-white shadow-[0_0_20px_rgba(124,58,237,0.4)] hover:shadow-[0_0_30px_rgba(124,58,237,0.6)] transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wider" disabled>
                        ‚è≥ Cargando...
                    </button>
                </div>
            </div>
        </main>

        <aside class="w-full md:w-80 glass-sidebar rounded-3xl p-6 md:sticky md:top-8 mb-8 md:mb-0 relative">
            <button id="toggleColleaguesBtn" onclick="toggleMasterView()" class="absolute -top-4 right-4 hidden bg-gradient-to-r from-purple-600 to-pink-600 text-white text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full shadow-lg hover:scale-105 transition-transform border border-white/20">
                üë• Ver Colegas
            </button>

            <div class="flex items-center justify-between mb-6 mt-2">
                <h3 id="sidebarTitle" class="font-bold text-lg text-white flex items-center gap-2">
                    Masters Activos
                    <span id="activeCount" class="bg-green-500/20 text-green-400 text-xs px-2 py-0.5 rounded-full border border-green-500/30">0</span>
                </h3>
                <span id="sidebarPulse" class="text-xs text-slate-300 animate-pulse">‚óè En vivo</span>
            </div>
            <div id="sidebarList" class="space-y-4">
                <p class="text-xs text-slate-300 text-center">Buscando compa√±eros...</p>
            </div>
            <div id="sidebarPromo" class="mt-8 p-4 bg-gradient-to-r from-purple-500/20 to-blue-500/20 rounded-2xl border border-purple-500/30 text-center">
                <p class="text-xs font-bold text-purple-200 mb-1">üî• Racha Semanal</p>
                <p class="text-[11px] text-slate-200">¬°La comunidad est√° creciendo!</p>
            </div>
        </aside>

    </div>

    <div id="loginModal" class="fixed inset-0 z-[60] hidden bg-[#0f172a]/90 backdrop-blur-md flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="w-full max-w-sm bg-[#1e293b] border border-white/10 rounded-[2rem] shadow-2xl p-8 text-center transform scale-95 transition-transform duration-300" id="loginBox">
            <div class="text-5xl mb-6">üöÄ</div>
            <h3 class="text-2xl font-black text-white mb-2">Bienvenido</h3>
            <p class="text-sm text-slate-300 mb-8 font-medium">√önete para conversar con los Masters.</p>
            
            <button onclick="loginWithGoogle()" class="w-full py-3.5 rounded-xl bg-white text-gray-800 font-bold shadow-lg hover:scale-105 transition-transform flex items-center justify-center gap-3">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.58c2.08-1.92 3.27-4.74 3.27-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar con Google
            </button>

            <button onclick="closeLogin()" class="mt-6 text-xs font-bold text-slate-400 hover:text-white transition-colors uppercase tracking-wider">Cancelar</button>
        </div>
    </div>

    <div id="chatModal" class="fixed inset-0 z-50 hidden bg-[#0f172a]/80 backdrop-blur-sm flex items-end md:items-center justify-center md:p-4 opacity-0 transition-opacity duration-300">
        <div class="w-full max-w-md bg-[#1e293b] border-t md:border border-white/10 rounded-t-[2rem] md:rounded-[2rem] shadow-2xl overflow-hidden flex flex-col h-[100dvh] max-h-[100dvh] md:h-[600px] md:max-h-[90vh] transform scale-95 transition-transform duration-300" id="chatBox">
            
            <div class="p-4 bg-white/5 border-b border-white/10 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="chatAvatar" class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center font-bold text-white shadow-lg text-xl overflow-hidden">
                        üë§
                    </div>
                    <div>
                        <h4 id="chatName" class="font-bold text-white leading-none">Cargando...</h4>
                        <p id="chatStatusText" class="text-[11px] text-green-400 font-medium mt-1 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 inline-block"></span> En l√≠nea
                        </p>
                    </div>
                </div>
                <button onclick="closeChat()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors">
                    ‚úï
                </button>
            </div>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll bg-gradient-to-b from-transparent to-black/20">
            </div>

            <div class="p-4 bg-white/5 border-t border-white/10 shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Escribe un mensaje..." class="flex-1 bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-[16px] text-white focus:outline-none focus:border-purple-500 transition-colors" onkeypress="handleKeyPress(event)">
                    <button onclick="sendChatMessage()" class="bg-gradient-to-r from-blue-600 to-purple-600 w-12 rounded-xl flex items-center justify-center hover:scale-105 transition-transform shadow-lg shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN DE FIREBASE 
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAKuWuseeobjUnGM2v5ycrR9pq5GIs1qUg",
            authDomain: "matchmaster-99fb3.firebaseapp.com",
            databaseURL: "https://matchmaster-99fb3-default-rtdb.firebaseio.com",
            projectId: "matchmaster-99fb3",
            storageBucket: "matchmaster-99fb3.firebasestorage.app",
            messagingSenderId: "431261424438",
            appId: "1:431261424438:web:94157e6c15534988c37197"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        let currentRoomRef = null; 
        
        // ==========================================
        // VARIABLES GLOBALES Y ROLES
        // ==========================================
        let currentUserData = null; 
        let myMasterProfile = null; 
        
        let allUsersData = []; 
        let currentSelectedMasterPhone = "";
        let currentSelectedMasterName = "";
        let currentSelectedMasterPhoto = "";

        let isViewingColleagues = false; // Variable para saber en qu√© vista est√° el Master

        // ==========================================
        // ESTADO DE AUTENTICACI√ìN (GOOGLE)
        // ==========================================
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserData = { uid: user.uid, nombre: user.displayName, foto: user.photoURL };
                
                document.getElementById('userProfileHeader').classList.remove('hidden');
                document.getElementById('userProfilePic').src = user.photoURL;
                document.getElementById('userProfileName').innerText = user.displayName.split(' ')[0]; 
                
                setupMyPresence();
                checkRoleAndRender();
            } else {
                currentUserData = null;
                myMasterProfile = null;
                isViewingColleagues = false;
                document.getElementById('userProfileHeader').classList.add('hidden');
                document.getElementById('toggleColleaguesBtn').classList.add('hidden');
                checkRoleAndRender();
            }
        });

        function loginWithGoogle() {
            auth.signInWithPopup(provider).then(() => {
                closeLogin();
                setTimeout(() => {
                    if(!myMasterProfile) simulateConnectionAndOpenChat();
                }, 1000);
            }).catch((error) => console.error("Error:", error));
        }

        function logoutGoogle() {
            auth.signOut().then(() => {
                if (currentUserData) db.ref('presence/' + currentUserData.uid).remove();
                alert("Has cerrado sesi√≥n correctamente.");
                window.location.reload();
            });
        }

        // ==========================================
        // L√ìGICA DE ROLES (¬øES MASTER O CLIENTE?)
        // ==========================================
        function checkRoleAndRender() {
            if (!currentUserData || allUsersData.length === 0) {
                if (allUsersData.length > 0) renderClientView(allUsersData);
                return;
            }

            const firstNameGoogle = currentUserData.nombre.split(' ')[0].toLowerCase();
            myMasterProfile = allUsersData.find(master => 
                master.Nombre && master.Nombre.toLowerCase().includes(firstNameGoogle)
            );

            if (myMasterProfile) {
                document.getElementById('toggleColleaguesBtn').classList.remove('hidden'); // Mostrar bot√≥n
                renderMasterDashboard(); 
            } else {
                renderClientView(allUsersData); 
            }
        }

        // ==========================================
        // VISTA DEL T√âCNICO (DASHBOARD MASTER)
        // ==========================================
        function renderMasterDashboard() {
            isViewingColleagues = false;
            document.getElementById('toggleColleaguesBtn').innerHTML = "üë• Ver Colegas";
            document.getElementById('toggleColleaguesBtn').className = "absolute -top-4 right-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full shadow-lg hover:scale-105 transition-transform border border-white/20";

            document.getElementById('mainTitle').innerHTML = `Bienvenido Master,<br><span class="text-gradient">${myMasterProfile.Nombre.split(' ')[0]}.</span>`;
            document.getElementById('mainSubtitle').innerText = "Tu Panel de Control";
            document.getElementById('mainDescription').innerText = "Aqu√≠ tienes tu bandeja de entrada privada. Selecciona un cliente en el panel lateral para responder a sus consultas.";

            document.getElementById('sidebarTitle').innerHTML = `Tus Mensajes <span id="activeCount" class="bg-blue-500/20 text-blue-400 text-xs px-2 py-0.5 rounded-full border border-blue-500/30">0</span>`;
            document.getElementById('sidebarPulse').innerText = "Privado";
            document.getElementById('sidebarPromo').style.display = 'none';

            // Escuchar chats de clientes
            db.ref(`chats/${myMasterProfile.Telefono}`).on('value', (snapshot) => {
                if (isViewingColleagues) return; // Si est√° viendo colegas, no repintar esto
                const clients = snapshot.val() || {};
                const sidebarList = document.getElementById('sidebarList');
                const numClients = Object.keys(clients).length;
                document.getElementById('activeCount').innerText = numClients;
                
                sidebarList.innerHTML = "";
                if(numClients === 0) {
                    sidebarList.innerHTML = `<p class="text-xs text-slate-300 text-center">Bandeja de entrada vac√≠a...</p>`;
                }

                for (const clientUid in clients) {
                    const messages = clients[clientUid];
                    const msgKeys = Object.keys(messages);
                    const lastMsg = messages[msgKeys[msgKeys.length - 1]]; 
                    
                    const clientName = lastMsg.uid === myMasterProfile.uid ? "Cliente (T√∫ respondiste)" : lastMsg.sender; 
                    const clientFoto = lastMsg.uid === myMasterProfile.uid ? "üë§" : (lastMsg.foto || "üë§");

                    sidebarList.innerHTML += `
                    <div onclick="openChatAsMaster('${clientUid}', '${clientName}', '${clientFoto}')" class="flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/10 hover:bg-white/20 transition cursor-pointer transform hover:scale-105">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center font-bold text-sm text-white overflow-hidden shrink-0 border border-white/20">
                            ${clientFoto.startsWith('http') ? `<img src="${clientFoto}" class="w-full h-full object-cover">` : clientFoto}
                        </div>
                        <div class="overflow-hidden w-full">
                            <h4 class="font-bold text-sm text-white leading-none truncate">${clientName}</h4>
                            <p class="text-[11px] text-blue-100 font-medium mt-1 truncate">${lastMsg.text}</p>
                        </div>
                    </div>
                    `;
                }
            });

            // Tarjeta principal (Inbox)
            const matchCard = document.getElementById('matchCard');
            matchCard.style.opacity = '1';
            matchCard.style.animation = 'float-card 4s ease-in-out infinite';
            document.getElementById('cardContent').innerHTML = `
                <div class="text-center p-6 py-10">
                    <div class="text-6xl mb-6">üì¨</div>
                    <h3 class="font-bold text-2xl text-white mb-2">Bandeja de Entrada</h3>
                    <p class="text-sm text-slate-300">Selecciona un chat del panel lateral para comenzar a ayudar a tus clientes.</p>
                </div>
            `;
        }

        // ==========================================
        // VISTA DE COLEGAS (SOLO PARA MASTERS)
        // ==========================================
        function toggleMasterView() {
            if (!myMasterProfile) return;

            isViewingColleagues = !isViewingColleagues;

            if (isViewingColleagues) {
                // Modo Colegas
                document.getElementById('toggleColleaguesBtn').innerHTML = "üì¨ Volver a mis chats";
                document.getElementById('toggleColleaguesBtn').className = "absolute -top-4 right-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full shadow-lg hover:scale-105 transition-transform border border-white/20";
                
                document.getElementById('mainTitle').innerHTML = `Directorio de<br><span class="text-gradient">Colegas.</span>`;
                document.getElementById('mainDescription').innerText = "Conecta con otros Masters y t√©cnicos para hacer networking o pedir ayuda en un proyecto.";
                
                // Mostrar a los otros masters (excluy√©ndome a m√≠ mismo)
                const colleagues = allUsersData.filter(u => u && u.Telefono !== myMasterProfile.Telefono);
                renderSidebar(colleagues); // Usamos la misma funci√≥n de sidebar
                
                // Resetear tarjeta
                if(colleagues.length > 0) {
                    renderMainCard(colleagues[0]);
                } else {
                    document.getElementById('cardContent').innerHTML = `<p class="text-center text-slate-300 p-6">No hay otros colegas disponibles.</p>`;
                }
            } else {
                // Volver a Bandeja de Entrada
                renderMasterDashboard();
            }
        }

        // ==========================================
        // VISTA DEL CLIENTE (LA ORIGINAL)
        // ==========================================
        function renderClientView(users) {
            renderSidebar(users);
            if(users.length > 0 && currentSelectedMasterPhone === "") {
                renderMainCard(users[0]);
            }
        }

        function renderMainCard(user) {
            const matchCard = document.getElementById('matchCard');
            matchCard.classList.remove('opacity-50');
            
            // Restaurar estructura de la tarjeta si venimos del Inbox
            if (document.getElementById('cardContent').innerHTML.includes('üì¨')) {
                document.getElementById('cardContent').innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div id="mainAvatar" class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center text-xl font-black shadow-lg text-white">
                                ‚è≥
                            </div>
                            <div>
                                <h3 id="mainName" class="font-bold text-xl leading-none text-white">Cargando...</h3>
                                <p class="text-xs text-blue-100 font-semibold mt-1">Conectando...</p>
                            </div>
                        </div>
                        <div id="mainStatus" class="bg-blue-500/30 text-blue-100 text-xs font-black px-3 py-1.5 rounded-full border border-blue-500/50 flex items-center gap-1">...</div>
                    </div>
                    <div class="space-y-4 mb-8">
                        <div>
                            <span class="text-[11px] text-slate-200 uppercase font-black tracking-widest">Tengo mucho conocimiento de:</span>
                            <div id="mainMasters" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                    </div>
                    <button id="connectBtn" class="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 font-black text-white shadow-[0_0_20px_rgba(124,58,237,0.4)] hover:shadow-[0_0_30px_rgba(124,58,237,0.6)] transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wider">
                        ‚ö° Conectar
                    </button>
                `;
            }

            currentSelectedMasterPhoto = user.Foto || "üë§";
            document.getElementById('mainAvatar').innerText = currentSelectedMasterPhoto;
            document.getElementById('mainName').innerText = user.Nombre;
            currentSelectedMasterName = user.Nombre.split(' ')[0]; 
            currentSelectedMasterPhone = user.Telefono;
            updateMainCardPresence();

            const masters = user.Master_En ? user.Master_En.split(',').map(s => s.trim()) : [];
            document.getElementById('mainMasters').innerHTML = masters.map(skill => 
                `<span class="bg-purple-600/40 text-white text-xs font-bold px-3 py-1.5 rounded-lg border border-purple-400/50 backdrop-blur-sm">‚ö° ${skill}</span>`
            ).join('');

            const btn = document.getElementById('connectBtn');
            if(btn) {
                btn.innerHTML = `‚ö° Conectar con ${currentSelectedMasterName}`;
                btn.disabled = false;
            }
        }

        function renderSidebar(users) {
            const validUsers = users.filter(u => u && u.Nombre);
            const onlineCount = validUsers.filter(u => isUserOnline(u.Nombre)).length;
            
            document.getElementById('sidebarTitle').innerHTML = `Masters Activos <span id="activeCount" class="bg-green-500/20 text-green-400 text-xs px-2 py-0.5 rounded-full border border-green-500/30">${onlineCount}</span>`;
            document.getElementById('sidebarPulse').innerText = "‚óè En vivo";
            if(document.getElementById('sidebarPromo')) document.getElementById('sidebarPromo').style.display = 'block';

            const sidebarList = document.getElementById('sidebarList');
            sidebarList.innerHTML = ""; 

            for(let i = 0; i < users.length; i++) {
                const u = users[i];
                if(!u || !u.Nombre) continue;
                const isOnline = isUserOnline(u.Nombre);
                const dotColor = isOnline ? "bg-green-500" : "bg-slate-600";
                const firstMaster = u.Master_En ? u.Master_En.split(',')[0] : "Varios";

                sidebarList.innerHTML += `
                <div onclick="changeMainCard(${i})" class="flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/10 hover:bg-white/20 transition cursor-pointer transform hover:scale-105">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center font-bold text-sm text-white">
                            ${u.Foto || "üë§"}
                        </div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 ${dotColor} border-2 border-[#0f172a] rounded-full transition-colors duration-300"></div>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-white leading-none">${u.Nombre}</h4>
                        <p class="text-[11px] text-blue-100 font-medium mt-1">Master en ${firstMaster}</p>
                    </div>
                </div>
                `;
            }
        }

        function changeMainCard(index) {
            // Permitir cambio de tarjeta si es Cliente o si es Master viendo Colegas
            if(myMasterProfile && !isViewingColleagues) return; 
            
            const matchCard = document.getElementById('matchCard');
            matchCard.style.opacity = '0.5';
            matchCard.style.transform = 'scale(0.95)';
            
            let usersToUse = allUsersData;
            if(isViewingColleagues) {
                usersToUse = allUsersData.filter(u => u && u.Telefono !== myMasterProfile.Telefono);
            }

            setTimeout(() => {
                renderMainCard(usersToUse[index]); 
                matchCard.style.opacity = '1';
                matchCard.style.transform = 'scale(1)';
            }, 200);
            if (window.innerWidth < 768) window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // OBTENER DATOS DE GOOGLE SHEETS
        // ==========================================
        const apiURL = "https://script.google.com/macros/s/AKfycbyU2ANFGImXYoXrIloC2lklFEOqrg3r0w0VWUmzsme3IXiijfz6ABpnRVUQNLruE5za/exec";

        async function loadDatabase() {
            try {
                const response = await fetch(apiURL);
                const data = await response.json();
                if(data && data.length > 0) {
                    allUsersData = data; 
                    checkRoleAndRender();
                }
            } catch (error) {
                console.error("Error al cargar Google Sheets:", error);
                if(document.getElementById('mainName')) document.getElementById('mainName').innerText = "Error de conexi√≥n";
            }
        }

        // ==========================================
        // SISTEMA DE PRESENCIA
        // ==========================================
        let activePresences = {};

        db.ref('presence').on('value', (snapshot) => {
            activePresences = snapshot.val() || {};
            // Repintar sidebar de clientes o colegas seg√∫n la vista actual
            if (allUsersData.length > 0) {
                if(!myMasterProfile) {
                    renderSidebar(allUsersData);
                } else if (isViewingColleagues) {
                    const colleagues = allUsersData.filter(u => u && u.Telefono !== myMasterProfile.Telefono);
                    renderSidebar(colleagues);
                }
                updateMainCardPresence(); 
            }
            updateChatPresence();
        });

        function setupMyPresence() {
            if (!currentUserData) return;
            const myPresenceRef = db.ref('presence/' + currentUserData.uid);
            db.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === true) {
                    myPresenceRef.onDisconnect().remove().then(() => {
                        myPresenceRef.set({ status: 'online', nombre: currentUserData.nombre });
                    });
                }
            });
        }

        function isUserOnline(masterName) {
            for (const key in activePresences) {
                if (activePresences[key].nombre && activePresences[key].nombre.includes(masterName.split(' ')[0])) return true;
            }
            return false;
        }

        function updateMainCardPresence() {
            const statusElement = document.getElementById('mainStatus');
            if (!statusElement || !currentSelectedMasterName) return;
            const isOnline = isUserOnline(currentSelectedMasterName);
            statusElement.innerHTML = isOnline 
                ? '<span class="relative flex h-2 w-2 mr-1"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span></span>Online'
                : '<span class="text-slate-400">Offline</span>';
            statusElement.className = isOnline 
                ? "bg-blue-500/30 text-blue-100 text-xs font-black px-3 py-1.5 rounded-full border border-blue-500/50 flex items-center gap-1 transition-colors"
                : "bg-slate-500/30 text-slate-300 text-xs font-bold px-3 py-1.5 rounded-full border border-slate-500/50 flex items-center gap-1 transition-colors";
        }

        function updateChatPresence() {
            const statusText = document.getElementById('chatStatusText');
            if (!statusText || !currentSelectedMasterName) return;
            const isOnline = isUserOnline(currentSelectedMasterName);
            if(isOnline) {
                statusText.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-500 inline-block"></span> En l√≠nea';
                statusText.className = "text-[11px] text-green-400 font-medium mt-1 flex items-center gap-1";
            } else {
                statusText.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-slate-500 inline-block"></span> Desconectado';
                statusText.className = "text-[11px] text-slate-400 font-medium mt-1 flex items-center gap-1";
            }
        }

        // ==========================================
        // SISTEMA DE CHAT PRIVADO E INTERNO
        // ==========================================
        const chatModal = document.getElementById('chatModal');
        const chatBox = document.getElementById('chatBox');
        const loginModal = document.getElementById('loginModal');
        const loginBox = document.getElementById('loginBox');

        document.addEventListener('click', function(e) {
            if(e.target && e.target.id === 'connectBtn') {
                if (!currentUserData) openLogin();
                else simulateConnectionAndOpenChat();
            }
        });

        function openLogin() {
            loginModal.classList.remove('hidden');
            setTimeout(() => {
                loginModal.classList.remove('opacity-0');
                loginBox.classList.remove('scale-95');
                loginBox.classList.add('scale-100');
            }, 10);
        }

        function closeLogin() {
            loginModal.classList.add('opacity-0');
            loginBox.classList.remove('scale-100');
            loginBox.classList.add('scale-95');
            setTimeout(() => loginModal.classList.add('hidden'), 300);
        }

        function simulateConnectionAndOpenChat() {
            const connectBtn = document.getElementById('connectBtn');
            const matchCard = document.getElementById('matchCard');
            
            const originalText = connectBtn.innerHTML;
            connectBtn.innerHTML = "‚è≥ Iniciando chat...";
            connectBtn.classList.add('btn-loading');
            matchCard.style.animation = 'none';
            matchCard.style.transform = 'scale(0.98)';

            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6', '#a855f7'], disableForReducedMotion: true });
            
            setTimeout(() => {
                connectBtn.innerHTML = originalText;
                connectBtn.classList.remove('btn-loading');
                matchCard.style.animation = 'float-card 4s ease-in-out infinite';
                
                if (isViewingColleagues && myMasterProfile) {
                    openChatWithColleague();
                } else {
                    openChatAsClient();
                }
            }, 1000);
        }

        // Cliente conectando con T√©cnico
        function openChatAsClient() {
            document.getElementById('chatName').innerText = currentSelectedMasterName;
            document.getElementById('chatAvatar').innerText = currentSelectedMasterPhoto;
            updateChatPresence(); 
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="flex flex-col items-center justify-center my-6">
                    <span class="text-[10px] text-slate-400 bg-white/5 px-3 py-1 rounded-full font-bold uppercase tracking-wider">Chat Privado</span>
                </div>
            `;

            if (currentRoomRef) currentRoomRef.off();
            const roomID = `chats/${currentSelectedMasterPhone}/${currentUserData.uid}`;
            currentRoomRef = db.ref(roomID);

            listenToChatRoom(chatMessages);
            showChatModal();
        }

        // T√©cnico viendo su Inbox
        function openChatAsMaster(clientUid, clientName, clientFoto) {
            document.getElementById('chatName').innerText = clientName;
            
            if(clientFoto.startsWith('http')) {
                document.getElementById('chatAvatar').innerHTML = `<img src="${clientFoto}" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('chatAvatar').innerText = clientFoto;
            }
            
            document.getElementById('chatStatusText').innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-500 inline-block"></span> Privado';
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="flex flex-col items-center justify-center my-6">
                    <span class="text-[10px] text-slate-400 bg-white/5 px-3 py-1 rounded-full font-bold uppercase tracking-wider">Respondiendo a Cliente</span>
                </div>
            `;

            if (currentRoomRef) currentRoomRef.off();
            const roomID = `chats/${myMasterProfile.Telefono}/${clientUid}`;
            currentRoomRef = db.ref(roomID);

            listenToChatRoom(chatMessages);
            showChatModal();
        }

        // NUEVO: T√©cnico hablando con otro T√©cnico (Colega)
        function openChatWithColleague() {
            document.getElementById('chatName').innerText = currentSelectedMasterName;
            document.getElementById('chatAvatar').innerText = currentSelectedMasterPhoto;
            updateChatPresence(); 
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="flex flex-col items-center justify-center my-6">
                    <span class="text-[10px] text-slate-400 bg-white/5 px-3 py-1 rounded-full font-bold uppercase tracking-wider">Chat Interno (Colegas)</span>
                </div>
            `;

            if (currentRoomRef) currentRoomRef.off();
            
            // LA MAGIA: Creamos un ID √∫nico combinando ambos tel√©fonos en orden alfab√©tico para que sea la misma sala para los dos
            const phones = [myMasterProfile.Telefono, currentSelectedMasterPhone].sort();
            const roomID = `chats_internos/${phones[0]}_${phones[1]}`;
            currentRoomRef = db.ref(roomID);

            listenToChatRoom(chatMessages);
            showChatModal();
        }

        function listenToChatRoom(chatMessagesContainer) {
            currentRoomRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                
                if(data.uid === currentUserData.uid) {
                    chatMessagesContainer.innerHTML += `
                        <div class="flex items-start justify-end gap-2 w-full ml-auto mt-2">
                            <div class="flex flex-col items-end max-w-[80%]">
                                <span class="text-[10px] text-slate-400 mb-1 pr-1 font-bold">T√∫</span>
                                <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl rounded-tr-sm px-4 py-2 text-sm text-white shadow-md break-words">
                                    ${data.text}
                                </div>
                            </div>
                            <img src="${data.foto || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full border border-white/20 shrink-0 object-cover mt-4">
                        </div>
                    `;
                } else {
                    chatMessagesContainer.innerHTML += `
                        <div class="flex items-start gap-2 w-full mt-2">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-cyan-400 to-blue-600 flex-shrink-0 flex items-center justify-center text-xs text-white font-bold border border-white/20 mt-4 overflow-hidden">
                                ${data.foto && data.foto.startsWith('http') ? `<img src="${data.foto}" class="w-full h-full object-cover">` : data.sender.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex flex-col items-start max-w-[80%]">
                                <span class="text-[10px] text-slate-400 mb-1 pl-1 font-bold">${data.sender.split(' ')[0]}</span>
                                <div class="bg-white/10 border border-white/5 rounded-2xl rounded-tl-sm px-4 py-2 text-sm text-slate-200 shadow-md break-words">
                                    ${data.text}
                                </div>
                            </div>
                        </div>
                    `;
                }
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; 
            });
        }

        function showChatModal() {
            chatModal.classList.remove('hidden');
            setTimeout(() => {
                chatModal.classList.remove('opacity-0');
                chatBox.classList.remove('scale-95');
                chatBox.classList.add('scale-100');
            }, 10);
            setTimeout(() => { document.getElementById('chatInput').focus(); }, 300);
        }

        function closeChat() {
            chatModal.classList.add('opacity-0');
            chatBox.classList.remove('scale-100');
            chatBox.classList.add('scale-95');
            setTimeout(() => chatModal.classList.add('hidden'), 300);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message !== "" && currentUserData && currentRoomRef) {
                currentRoomRef.push({
                    uid: currentUserData.uid,
                    sender: currentUserData.nombre,
                    foto: currentUserData.foto,
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = ""; 
            }
        }

        function handleKeyPress(event) { if (event.key === 'Enter') sendChatMessage(); }

        document.getElementById('chatInput').addEventListener('focus', function() {
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 300);
        });

        window.onload = loadDatabase;

    </script>
</body>
</html>